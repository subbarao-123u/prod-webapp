pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'subbu45340/prod-webapp'
        VM_IP = '172.31.10.17'  // Your production VM public IP
        VM_USER = 'ubuntu'
        APP_PORT = '8081'        // Avoid jenkins port 8080
    }
    stages {
        stage('Build') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                }
            }
        }
        stage('Push') {
            steps {
                withDockerRegistry([credentialsId: 'subbu-docker-creds', url: '']) {  // Your Docker Hub cred ID
                    script {
                        def image = docker.image("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        stage('Deploy to Production') {
            steps {
                withCredentials([file(credentialsId: 'my.pem', variable: 'PEM_FILE')]) {  // Your SSH key ID
                    sh """
                        ssh -i \$PEM_FILE -o StrictHostKeyChecking=no ${VM_USER}@${VM_IP} '
                            docker pull ${DOCKER_IMAGE}:latest &&
                            docker stop prod-webapp || true &&
                            docker rm prod-webapp || true &&
                            docker run -d -p ${APP_PORT}:5000 --restart unless-stopped --name prod-webapp ${DOCKER_IMAGE}:latest &&
                            sleep 3 &&
                            curl -f http://localhost:${APP_PORT}/health || exit 1
                        '
                    """
                }
            }
        }
    }
    post {
        success {
            echo "âœ… LIVE: http://${VM_IP}:${APP_PORT}"
        }
    }
}

