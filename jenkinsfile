pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'subbu45340/prod-webapp'
        VM_IP = '18.60.255.245'  // Your production VM public IP
        VM_USER = 'ubuntu'
        APP_PORT = '8081'        // Avoid jenkins port 8080
    }
    stages {
        stage('Build') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                }
            }
        }
        stage('Push') {
            steps {
                withDockerRegistry([credentialsId: 'subbu-docker-creds', url: '']) {  // Your Docker Hub cred ID
                    script {
                        def image = docker.image("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                   docker pull subbu45340/prod-webapp:latest &&
                   docker stop prod-webapp || true &&
                   docker rm prod-webapp || true &&
                   docker run -d -p 8081:5000 --restart unless-stopped --name prod-webapp subbu45340/prod-webapp:latest &&
                   sleep 5 &&
                   curl -f http://localhost:8081/health || exit 1

                """
                }
            }
        }
    }
    post {
        success {
            echo "âœ… LIVE: http://${VM_IP}:${APP_PORT}"
        }
    }
}

