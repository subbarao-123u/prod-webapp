pipeline {
    agent any
    environment {
        DOCKER_IMAGE = 'subbu45340/prod-webapp'
        APP_PORT = '8081'
    }
    stages {
        stage('Build') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                }
            }
        }
        stage('Push') {
            steps {
                withDockerRegistry([credentialsId: 'subbu-docker-creds', url: '']) {
                    script {
                        def image = docker.image("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                    docker pull ${DOCKER_IMAGE}:latest &&
                    docker stop prod-webapp || true &&
                    docker rm prod-webapp || true &&
                    docker run -d -p ${APP_PORT}:5000 --restart unless-stopped --name prod-webapp ${DOCKER_IMAGE}:latest &&
                    sleep 5 &&
                    curl -f http://localhost:${APP_PORT}/health || exit 1
                '''
            }
        }
    }
    post {
        success {
            echo "âœ… LIVE: http://18.60.255.245:${APP_PORT}"
        }
    }
}

